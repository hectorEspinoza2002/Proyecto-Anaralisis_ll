<div class="container mt-4">
  <h3>Estado de Cuenta</h3>

  <!-- 🔍 Input de búsqueda -->
  <div class="form-group mb-3">
    <label class="form-label fw-bold">Buscar Cliente:</label>
    <input
      type="text"
      class="form-control"
      placeholder="Ingrese Número de cuenta o ID o Nombre del cliente"
      [(ngModel)]="personaBusqueda"
      name="personaBusqueda"
      (input)="buscarPersona()"
    />

    <!-- Resultados de búsqueda -->
    <ul class="list-group mt-2" *ngIf="personasFiltradas.length > 0">
      <li
        class="list-group-item list-group-item-action"
        *ngFor="let p of personasFiltradas"
        (click)="seleccionarPersona(p)"
      >
        {{ p.idPersona }} - {{ p.nombre }} {{ p.apellido }}
      </li>
    </ul>
  </div>

  <!-- 👤 Datos del cliente -->
  <div *ngIf="personaSeleccionada" class="mt-4">
    <h5>Cliente Seleccionado:</h5>
    <p><strong>ID:</strong> {{ personaSeleccionada.idPersona }}</p>
    <p>
      <strong>Nombre:</strong>
      {{ personaSeleccionada.nombre }} {{ personaSeleccionada.apellido }}
    </p>
  </div>

  <!-- 💳 Estado de cuenta por cada cuenta -->
  <div *ngFor="let cuenta of cuentas" class="card mt-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        Cuenta N° {{ cuenta.idSaldoCuenta }} — {{ cuenta.tipoSaldoCuenta.nombre }}
      </h5>
    </div>

    <div class="card-body">
      <p><strong>Saldo Anterior:</strong> Q{{ cuenta.saldoAnterior | number:'1.2-2' }}</p>

      <!-- 🧾 Tabla de movimientos -->
      <table class="table table-striped table-bordered mt-3">
        <thead class="table-dark">
          <tr>
            <th>Fecha</th>
            <th>Tipo Movimiento</th>
            <th>Descripción</th>
            <th>Cargo (Q)</th>
            <th>Abono (Q)</th>
            <th>Saldo Acumulado (Q)</th>
          </tr>
        </thead>
        <tbody>

          <tr *ngIf="!cuenta.movimientos?.length">
            <td colspan="6" class="text-center text-muted">
              Sin movimientos en este período
            </td>
          </tr>
          <tr *ngFor="let m of cuenta.movimientos; let i = index">
            <td>{{ m.fechaMovimiento | date: 'dd/MM/yyyy' }}</td>
            <td>{{ m.tipoMovimiento }}</td>
            <td>{{ m.descripcion }}</td>
            <td class="text-end">Q{{ m.cargos | number:'1.2-2' }}</td>
            <td class="text-end">Q{{ m.abonos | number:'1.2-2' }}</td>
            <td class="text-end">
              Q{{ calcularSaldoHasta(cuenta, i) | number: '1.2-2' }}
            </td>
          </tr>
        </tbody>
      </table>

      <!-- 🔹 Totales -->
      <div class="d-flex justify-content-end mt-3">
        <div class="text-end">
          <p><strong>Total Cargos:</strong> Q{{ getTotalCargos() | number:'1.2-2' }}</p>
          <p><strong>Total Abonos:</strong> Q{{ getTotalAbonos() | number:'1.2-2' }}</p>
          <p><strong>Saldo Final:</strong>
            Q{{ getSaldoFinalPorCuenta(cuenta) | number:'1.2-2' }}
          </p>
        </div>
      </div>

      <!-- 📤 Botones de exportar -->
      <div class="text-end mt-3">
        <button
          *ngIf="puedeImprimir"
          (click)="generarPdf(cuenta)"
          class="btn btn-outline-danger btn-sm me-2"
        >
          <i class="bi bi-file-pdf"></i> PDF
        </button>
        <button
          *ngIf="puedeExportar"
          (click)="generarExcel(cuenta)"
          class="btn btn-outline-success btn-sm"
        >
          <i class="bi bi-file-excel"></i> Excel
        </button>
      </div>
    </div>
  </div>

  <!-- ⚠️ Si no hay cuentas -->
  <div
    *ngIf="personaSeleccionada && cuentas.length === 0"
    class="alert alert-warning mt-4"
  >
    El cliente no tiene cuentas registradas.
  </div>
</div>
